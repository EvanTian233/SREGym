apiVersion: v1
kind: ConfigMap
metadata:
  name: locust-config
  namespace: {{ .Values.namespace }}
data:
  locustfile.py: |
    import random
    import time
    from locust import HttpUser, task, between
    import json

    class TrainTicketUser(HttpUser):
        wait_time = between(1, 3)

        def on_start(self):
            """Login to TrainTicket system"""
            self.client.verify = False
            self.login()

        def login(self):
            """Perform user login"""
            response = self.client.post("/api/v1/users/login",
                json={
                    "username": "fdse_microservice",
                    "password": "111111"
                },
                headers={"Content-Type": "application/json"}
            )
            if response.status_code == 200:
                data = response.json()
                self.token = data.get("data", {}).get("token", "")
                self.user_id = data.get("data", {}).get("userId", "")
                self.headers = {
                    "Authorization": f"Bearer {self.token}",
                    "Content-Type": "application/json"
                }
            else:
                print(f"Login failed: {response.status_code}")
                self.token = ""
                self.user_id = ""
                self.headers = {"Content-Type": "application/json"}

        @task(3)
        def search_tickets(self):
            """Search for available train tickets"""
            self.client.get("/api/v1/travelservice/trips/left",
                headers=self.headers,
                name="/trips/search"
            )

        @task(2)
        def view_orders(self):
            """View user orders"""
            if self.user_id:
                self.client.get(f"/api/v1/orderservice/order/refresh",
                    headers=self.headers,
                    name="/orders/view"
                )

        @task(1)
        def create_and_cancel_order(self):
            """Create an order and then cancel it - triggers F1 fault"""
            if not self.user_id:
                return

            # Create order
            order_data = {
                "accountId": self.user_id,
                "contactsId": "contacts_" + self.user_id,
                "tripId": "D1345",
                "seatType": 2,
                "date": "2025-07-01",
                "from": "Shanghai",
                "to": "Beijing"
            }

            create_response = self.client.post("/api/v1/preserveservice/preserve",
                json=order_data,
                headers=self.headers,
                name="/order/create"
            )

            if create_response.status_code == 200:
                order_info = create_response.json().get("data", {})
                order_id = order_info.get("orderId")

                if order_id:
                    # Wait a bit before canceling
                    time.sleep(2)

                    # Cancel the order - this triggers F1 fault
                    self.client.get(f"/api/v1/cancelservice/cancel/{order_id}",
                        headers=self.headers,
                        name="/order/cancel"
                    )

        @task(5)
        def browse_stations(self):
            """Browse train stations"""
            self.client.get("/api/v1/stationservice/stations",
                headers=self.headers,
                name="/stations/list"
            )
